(()=>{"use strict";var t,e=function(t){void 0===t&&(t=!1),this.class="",this.doubleExport=!1,this.cells=[],this.extraCells=[],this.doubleExport=t},n=function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{l(o.next(t))}catch(t){i(t)}}function a(t){try{l(o.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((o=o.apply(t,e||[])).next())}))},o=function(t,e){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},r=function(){function t(t,e){void 0===e&&(e=!1),this.tableId="",this.tableHeaders=[],this.tableRows=[],this.tableId=t,e||this.attachChangeEventListeners()}return t.prototype.consoleLog=function(){console.log(this)},t.prototype.addRow=function(){return n(this,void 0,void 0,(function(){var t,n;return o(this,(function(o){for(t=new e,n=0;n<this.tableHeaders.length;n++)t.cells.push(this.tableHeaders[n].default);return this.tableRows.push(t),[2]}))}))},t.prototype.addRowBegin=function(){return n(this,void 0,void 0,(function(){var t,n;return o(this,(function(o){for(t=new e,n=0;n<this.tableHeaders.length;n++)t.cells.unshift(this.tableHeaders[n].default);return this.tableRows.unshift(t),[2]}))}))},t.prototype.addRowBefore=function(t){return n(this,void 0,void 0,(function(){var n,r;return o(this,(function(o){for(n=new e,r=0;r<this.tableHeaders.length;r++)n.cells.push(this.tableHeaders[r].default);return this.tableRows.splice(t,0,n),[2]}))}))},t.prototype.addRowAfter=function(t){return n(this,void 0,void 0,(function(){var n,r;return o(this,(function(o){for(n=new e,r=0;r<this.tableHeaders.length;r++)n.cells.push(this.tableHeaders[r].default);return this.tableRows.splice(t+1,0,n),[2]}))}))},t.prototype.swapRows=function(t,e){var n=this.tableRows[t];this.tableRows[t]=this.tableRows[e],this.tableRows[e]=n},t.prototype.updateRow=function(t,e){this.tableRows[e]=t},t.prototype.deleteRow=function(t){this.tableRows.splice(t,1)},t.prototype.deleteAllRows=function(){this.tableRows=[]},t.prototype.ReadRows=function(){return n(this,arguments,void 0,(function(t){var n,r,i,s,a,l;return void 0===t&&(t=0),o(this,(function(t){if(null==(n=$("#".concat(this.tableId))))return[2];if(0==(r=n.find("tbody tr")).length)return console.error("No rows found in table"),[2];for(this.tableRows=[],i=function(t){var n=!1;t+1<r.length&&r[t+1].classList.contains("extra-output")&&(n=!0);var o=new e(n);$(r[t]).find("td").each((function(t,e){var n=$(e),r=n.find("input").val(),i=n.find("select").val(),s=void 0!==r?r:i;o.cells.push(s)})),n&&($(r[t+1]).find("td").each((function(t,e){var n=$(e),r=n.find("input").val(),i=n.find("select").val(),s=void 0!==r?r:i;o.extraCells.push(s)})),t++),s.tableRows.push(o),a=t},s=this,l=0;l<=r.length-1;l++)i(l),l=a;return[2]}))}))},t.prototype.renderTable=function(t){void 0===t&&(t=!1);for(var e="",n=0;n<this.tableRows.length;n++){var o=this.tableRows[n],r="";e+="<tr>";for(var i=0;i<o.cells.length;i++){var s=(b=this.tableHeaders[i]).ReadOnly?"readonly":"",a=b.min>=0?'min="'+b.min+'"':"",l=b.max>0?'max="'+b.max+'"':"",c="number"===b.InputType?'step="any"':"",u="",h="";if(o.doubleExport&&i<2&&(u='rowspan="2"',h='style="height: 78px"'),"select"===b.InputType){for(var d in e+='<td class="m-0 p-0 '+b.class+'" '+u+'><select class="form-control rounded-0" '+s+' name="'+b.InputName+'" '+h+" "+a+" "+l+">",b.Options){var p=b.Options[d].value==o.cells[i]?"selected":"",f=b.Options[d].disabled?"disabled":"";n==this.tableRows.length-1&&"0"==d&&(p="selected"),e+='<option value="'+b.Options[d].value+'" '+p+" "+f+">"+b.Options[d].display+"</option>"}e+="</select></td>"}else e+='<td class="m-0 p-0 '+b.class+'" '+u+'><input type="'+this.tableHeaders[i].InputType+'" value="'+o.cells[i]+'" class="form-control rounded-0" '+s+' name="'+b.InputName+'" '+h+" "+a+" "+l+" "+c+"></td>"}if(e+="</tr>",(o=this.tableRows[n]).doubleExport){for(r='<tr class="extra-output">',i=0;i<o.extraCells.length;i++){s=(b=this.tableHeaders[i+2]).ReadOnly?"readonly":"",a=b.min>0?'min="'+b.min+'"':"",l=b.max>0?'max="'+b.max+'"':"",c="number"===b.InputType?'step="any"':"";var b,w=b.InputName;w=w.replace("[","2["),r+='<td class="m-0 p-0" ><input type="'+b.InputType+'" value="'+o.extraCells[i]+'" class="form-control rounded-0" '+s+' name="'+w+'" '+c+" "+a+" "+l+"></td>"}r+="</tr>"}e+=r}t&&(e+=t.html()),$("#"+this.tableId).find("tbody").html(e),this.attachChangeEventListeners()},t.prototype.attachChangeEventListeners=function(){var t=document.getElementById(this.tableId);if(t){for(var e=t.getElementsByTagName("input"),n=t.getElementsByTagName("select"),o=0;o<e.length;o++)e[o].addEventListener("change",this.handleChange.bind(this));for(o=0;o<n.length;o++)n[o].addEventListener("change",this.handleChange.bind(this))}else console.error("Table with ID ".concat(this.tableId," not found."))},t.prototype.handleChange=function(t){console.log("Table element changed:",t)},t.prototype.checkIfLastRow=function(t){return t.is(":last-child")},t.prototype.checkIfSelect=function(t){return t.is("select")},t.prototype.checkIfInputNumber=function(t){return t.is('input[type="number"]')},t.prototype.getRecipe=function(t){return new Promise((function(e,n){$.ajax({type:"GET",url:"getRecipe",data:{id:t},success:function(t){try{e(JSON.parse(t))}catch(t){n(t)}},error:function(t,e,o){n(o)}})}))},t.prototype.getBuilding=function(t){return new Promise((function(e,n){$.ajax({type:"GET",url:"getBuilding",data:{id:parseInt(t)},success:function(t){try{e(JSON.parse(t))}catch(t){n(t)}},error:function(t,e,o){n(o)}})}))},t.prototype.importData=function(t){this.tableRows=t.tableRows,this.renderTable()},t}(),i=function(t,e,n,o,r,i,s,a,l){void 0===n&&(n=!1),void 0===o&&(o={}),void 0===r&&(r=""),void 0===i&&(i=""),void 0===s&&(s=0),void 0===a&&(a=0),void 0===l&&(l=""),this.class="",this.Name="",this.InputType="",this.ReadOnly=!1,this.Options={},this.InputName="",this.default="",this.min=0,this.max=0,this.Name=t,this.InputType=e,this.ReadOnly=n,this.Options=o,this.InputName=r,this.default=i,this.min=s,this.max=a,this.class=l},s=(t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)},function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}),a=function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{l(o.next(t))}catch(t){i(t)}}function a(t){try{l(o.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((o=o.apply(t,e||[])).next())}))},l=function(t,e){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},c=function(t){function e(e,n,o){void 0===o&&(o=!1);var r,s=t.call(this,e,o)||this;s.productionTable=n;var a=$("#power tbody tr");return r=(a=$(a[a.length-2]).find("td select")).length>0?a.find("option").map((function(t,e){var n=!!e.disabled;return{value:e.value,display:e.text,disabled:n}})).get():{},s.tableHeaders=[new i("Name","select",!1,r,"power_building_id[]","",0,0,"w-50"),new i("Amount","number",!1,{},"power_amount[]","1",0,0,"w-25"),new i("Clock Speed","number",!1,{},"power_clock_speed[]","100",1,250,"w-25"),new i("Consumption","number",!0,{},"power_Consumption[]","0",0,0,"w-25"),new i("user","hidden",!0,{},"user[]","1",0,0,"w-25")],s.ReadRows(),s.Footer=$("#".concat(s.tableId," tbody tr:last")),s.deleteRow(s.tableRows.length-1),s}return s(e,t),e.prototype.renderTable=function(){return a(this,void 0,void 0,(function(){return l(this,(function(e){return t.prototype.renderTable.call(this,this.Footer),[2]}))}))},e.prototype.handleChange=function(t){return a(this,void 0,void 0,(function(){var e,n;return l(this,(function(o){switch(o.label){case 0:return[4,this.ReadRows()];case 1:return o.sent(),this.deleteRow(this.tableRows.length-1),e=$(t.target),n=$(e).closest("tr"),this.checkIfSecondLastRow(n)&&this.checkIfSelect(e)?[4,this.addRow()]:[3,3];case 2:o.sent(),o.label=3;case 3:return[4,this.calculatePowerUsage()];case 4:return o.sent(),[2]}}))}))},e.prototype.checkIfSecondLastRow=function(t){return $(t).closest("tr").is($("#".concat(this.tableId," tbody tr:nth-last-child(2)")))},e.prototype.calculatePowerUsage=function(){return a(this,void 0,void 0,(function(){var t,e=this;return l(this,(function(n){switch(n.label){case 0:return this.productionTable.deleteRow(this.productionTable.tableRows.length-1),this.deleteNonUserRows(),t=this.productionTable.tableRows.map((function(t){return a(e,void 0,void 0,(function(){var e,n,o,r,i,s,a;return l(this,(function(l){switch(l.label){case 0:return[4,this.getRecipe(+t.cells[0])];case 1:return e=l.sent(),[4,this.getBuilding(e.buildings_id)];case 2:return n=l.sent(),o=this.calculateBuildingAmount(+t.cells[1],+e.export_amount_per_min),!1!==(r=this.checkIfBuildingAlreadyExists(n.id))?(i=Number(this.tableRows[r].cells[1])||0,s=Number(o.amount)||0,a=(i+s).toString(),this.tableRows[r].cells[1]=a,this.tableRows[r].cells[3]=this.calculateConsumption(+a,100,n.power_used).toString(),o.remainder>0&&this.addRemainderRow(o,n,r),[2]):(o.amount>0&&(this.addRowBegin(),this.tableRows[0].cells=[n.id,o.amount,100,this.calculateConsumption(o.amount,100,n.power_used),0]),o.remainder>0&&this.addRemainderRow(o,n),[2])}}))}))})),[4,this.calculateUserRows()];case 1:return n.sent(),[4,Promise.all(t)];case 2:return n.sent(),[4,this.applyTotalConsumption()];case 3:return n.sent(),[4,this.flipOrderOfNonUserRows()];case 4:return n.sent(),this.renderTable(),[2]}}))}))},e.prototype.calculateBuildingAmount=function(t,e){var n=t/e;return n%1!=0?{amount:Math.floor(n),remainder:n%1}:{amount:n,remainder:0}},e.prototype.checkIfBuildingAlreadyExists=function(t){for(var e=0;e<this.tableRows.length;e++)if(this.tableRows[e].cells[0]==t.toString()&&"0"==this.tableRows[e].cells[4]&&"100"==this.tableRows[e].cells[2])return e;return!1},e.prototype.addRemainderRow=function(t,e,n){void 0===n&&(n=!1);var o=parseFloat((100*t.remainder).toFixed(3));if(o*=1,n)return this.addRowBefore(n),void(this.tableRows[n].cells=[e.id,1,o,this.calculateConsumption(1,o,e.power_used),0]);this.addRowBegin(),this.tableRows[0].cells=[e.id,1,o,this.calculateConsumption(1,o,e.power_used),0]},e.prototype.calculateConsumption=function(t,e,n){return parseFloat((t*n*(e/100)).toFixed(3))},e.prototype.calculateTotalConsumption=function(){return a(this,void 0,void 0,(function(){var t,e;return l(this,(function(n){for(t=0,e=0;e<this.tableRows.length;e++)t+=+this.tableRows[e].cells[3];return[2,Math.round(t)]}))}))},e.prototype.applyTotalConsumption=function(){return a(this,void 0,void 0,(function(){var t;return l(this,(function(e){switch(e.label){case 0:return[4,this.calculateTotalConsumption()];case 1:return t=e.sent(),this.Footer.find("input").attr("value",t.toString()),[2]}}))}))},e.prototype.deleteNonUserRows=function(){for(var t=0;t<this.tableRows.length;t++)"1"!=this.tableRows[t].cells[4]&&(this.deleteRow(t),t--)},e.prototype.flipOrderOfNonUserRows=function(){return a(this,void 0,void 0,(function(){var t;return l(this,(function(e){for(t=0;t<this.tableRows.length;t++)"1"!=this.tableRows[t].cells[4]&&(this.addRowBegin(),this.tableRows[0]=this.tableRows[t+1],this.deleteRow(t+1));return[2]}))}))},e.prototype.calculateUserRows=function(){return a(this,void 0,void 0,(function(){var t,e;return l(this,(function(n){switch(n.label){case 0:t=0,n.label=1;case 1:return t<this.tableRows.length?"1"!=this.tableRows[t].cells[4]?[3,3]:this.tableRows[t].cells[0]?[4,this.getBuilding(this.tableRows[t].cells[0])]:[3,3]:[3,4];case 2:e=n.sent(),this.tableRows[t].cells[3]=this.calculateConsumption(+this.tableRows[t].cells[1],+this.tableRows[t].cells[2],e.power_used).toString(),n.label=3;case 3:return t++,[3,1];case 4:return[2]}}))}))},e.prototype.importData=function(t){return a(this,void 0,void 0,(function(){return l(this,(function(e){switch(e.label){case 0:return this.tableRows=t.tableRows,[4,this.applyTotalConsumption()];case 1:return e.sent(),this.renderTable(),[2]}}))}))},e}(r),u=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),h=function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{l(o.next(t))}catch(t){i(t)}}function a(t){try{l(o.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((o=o.apply(t,e||[])).next())}))},d=function(t,e){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},p=function(t){function e(e,n,o,r){void 0===o&&(o=!1),void 0===r&&(r=!1);var s,a=t.call(this,e,o)||this;a.productionTable=n;var l=$("#imports tbody tr:last td select");return s=l.length>0?l.find("option").map((function(t,e){var n=!!e.disabled;return{value:e.value,display:e.text,disabled:n}})).get():{},a.tableHeaders=[new i("Item","select",!1,s,"imports_item_id[]","",0,0,"w-75"),new i("Amount","number",!1,{},"imports_ammount[]","",0,0,"w-25")],r||a.ReadRows(),a}return u(e,t),e.prototype.handleChange=function(t){return h(this,void 0,void 0,(function(){var e,n;return d(this,(function(o){switch(o.label){case 0:return[4,this.ReadRows()];case 1:return o.sent(),e=$(t.target),n=$(e).closest("tr"),this.checkIfLastRow(n)&&this.checkIfSelect($(e))?[4,this.addRow()]:[3,3];case 2:o.sent(),o.label=3;case 3:return this.productionTable.handleChange(t),[2]}}))}))},e.prototype.calculateImport=function(){return h(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return[4,this.processImports()];case 1:return t.sent(),[4,this.processTableRows()];case 2:return t.sent(),this.consoleLog(),this.productionTable.consoleLog(),this.addRow(),this.renderTable(),this.productionTable.addRow(),this.productionTable.renderTable(),[2]}}))}))},e.prototype.processImports=function(){return h(this,void 0,void 0,(function(){var t,e,n,o,r,i,s=this;return d(this,(function(a){switch(a.label){case 0:t=this.productionTable.tableRows,this.deleteAllRows(),e=function(t){var e,o,r,i,a,l,c,u;return d(this,(function(h){switch(h.label){case 0:return e=+t.cells[0],o=+t.cells[1],r=n.getRecipeImports(e),i=n.getRecipe(e),r&&i?[4,Promise.all([r,i])]:[2,"continue"];case 1:return a=h.sent(),l=a[0],c=a[1],u=o/c.export_amount_per_min,l.forEach((function(t){var e=t.importAmount*u,n=s.checkIfImportAlreadyExists(t.itemId);e.toFixed(3),!1!==n?s.tableRows[n].cells[1]=(1*parseFloat((1*(+s.tableRows[n].cells[1]+e)).toFixed(3))).toString():e>0&&(s.addRow(),s.tableRows[s.tableRows.length-1].cells=[t.itemId,(1*parseFloat((1*e).toFixed(3))).toString()])})),[2]}}))},n=this,o=0,r=t,a.label=1;case 1:return o<r.length?(i=r[o],[5,e(i)]):[3,4];case 2:a.sent(),a.label=3;case 3:return o++,[3,1];case 4:return[2]}}))}))},e.prototype.processTableRows=function(){return h(this,void 0,void 0,(function(){var t,e,n,o,r,i,s,a,l;return d(this,(function(c){switch(c.label){case 0:t=0,c.label=1;case 1:return t<this.tableRows.length?(e=this.tableRows[t].cells[0],[4,this.checkIfAlreadyProduced(e)]):[3,4];case 2:if(!1!==(n=c.sent()))for(o=+this.tableRows[t].cells[1],r=0,i=n;r<i.length;r++){if(s=i[r],a=s.index,l=s.double,(o=this.updateProductionRow(a,o,l))<=0){this.deleteRow(t),t--;break}this.tableRows[t].cells[1]=o.toString()}c.label=3;case 3:return t++,[3,1];case 4:return[2]}}))}))},e.prototype.checkIfImportAlreadyExists=function(t){for(var e=0;e<this.tableRows.length;e++)if(this.tableRows[e].cells[0]==t)return e;return!1},e.prototype.checkIfAlreadyProduced=function(t){return h(this,void 0,void 0,(function(){var e,n,o,r,i;return d(this,(function(s){switch(s.label){case 0:return[4,this.getItemName(+t)];case 1:e=s.sent(),n=[{double:!1,index:0}],o=0,s.label=2;case 2:return o<this.productionTable.tableRows.length?((r=this.productionTable.tableRows[o]).cells[2]==e&&(r.cells[3]="0",r.cells[4]=r.cells[1],n.push({double:!1,index:o})),r.doubleExport&&r.extraCells[0]==e?(r.extraCells[1]="0",[4,this.getRecipe(+r.cells[0])]):[3,4]):[3,5];case 3:i=s.sent(),this.productionTable.handleDoubleExport(r,i,+r.cells[1]),n.push({double:!0,index:o}),s.label=4;case 4:return o++,[3,2];case 5:return 1==n.length?[2,!1]:(n.shift(),[2,n])}}))}))},e.prototype.updateProductionRow=function(t,e,n){return n?this.updateDoubleRow(t,e):this.updateSingleRow(t,e)},e.prototype.updateDoubleRow=function(t,e){var n=this.productionTable.tableRows[t],o=Math.min(e,+n.extraCells[2]),r=e-+n.extraCells[2];return n.extraCells[1]=o.toString(),n.extraCells[2]=(+n.extraCells[2]-o).toString(),r>0?r:0},e.prototype.updateSingleRow=function(t,e){var n=this.productionTable.tableRows[t],o=+n.cells[1],r=Math.min(e,o),i=e-o;return n.cells[3]=r.toString(),n.cells[4]=(o-r).toString(),i>0?i:0},e.prototype.getRecipeImports=function(t){return h(this,void 0,void 0,(function(){return d(this,(function(e){return[2,new Promise((function(e,n){$.ajax({type:"GET",url:"getRecipeResources",data:{id:t},success:function(t){try{e(JSON.parse(t))}catch(t){n(t)}},error:function(t,e,o){n(o)}})}))]}))}))},e.prototype.getItemName=function(t){return h(this,void 0,void 0,(function(){return d(this,(function(e){return[2,new Promise((function(e,n){$.ajax({type:"GET",url:"getItemName",data:{id:t},success:function(t){try{e(t)}catch(t){n(t)}},error:function(t,e,o){n(o)}})}))]}))}))},e}(r),f=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),b=function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{l(o.next(t))}catch(t){i(t)}}function a(t){try{l(o.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((o=o.apply(t,e||[])).next())}))},w=function(t,e){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},v=function(t){function e(e,n){void 0===n&&(n=!1);var o,r=t.call(this,e,n)||this,s=$("#recipes tbody tr:last td select");return o=s.length>0?s.find("option").map((function(t,e){var n=!!e.disabled;return{value:e.value,display:e.text,disabled:n}})).get():{},r.tableHeaders=[new i("Recipe","select",!1,o,"production_recipe_id[]"),new i("Quantity Per/min","number",!1,{},"production_quantity[]","1",0),new i("Product","text",!0),new i("Usage Per/min","number",!0,{},"production_usage[]","0",0),new i("Export Per/min","number",!0,{},"production_export[]","0",0)],r.ReadRows(),r}return f(e,t),e.prototype.handleChange=function(t){return b(this,void 0,void 0,(function(){var e,n,o,r;return w(this,(function(i){switch(i.label){case 0:return[4,this.ReadRows()];case 1:return i.sent(),e=$(t.target),n=$(e).closest("tr"),this.checkIfLastRow(n)&&this.checkIfSelect($(e))?[4,this.addRow()]:[3,3];case 2:i.sent(),i.label=3;case 3:return[4,this.calculateExport()];case 4:return i.sent(),o=new p("imports",this,!0,!0),r=new c("power",this,!0),Promise.all([this.renderTable(),o.calculateImport(),r.calculatePowerUsage()]),[2]}}))}))},e.prototype.calculateExport=function(){return b(this,void 0,void 0,(function(){var t,e,n,o,r,i,s,a,l=this;return w(this,(function(c){switch(c.label){case 0:return t=this.tableRows.slice(0,-1).map((function(t){return l.getRecipe(+t.cells[0])})),[4,Promise.all(t)];case 1:for(e=c.sent(),n=0;n<this.tableRows.length-1;n++)o=this.tableRows[n],r=+o.cells[1],i=+o.cells[3],s=r-i,r<i?o.cells[3]=r.toString():this.checkIfNumbersAreValid(r,i,s)?(a=e[n],o.cells[2]=(null==a?void 0:a.itemName)||"",null!=a.export_amount_per_min2?this.handleDoubleExport(o,a,r):o.doubleExport&&(o.extraCells=[],o.doubleExport=!1),o.cells[4]=s.toString()):this.correctInvalidNumbers(o,r,i,s);return[2]}}))}))},e.prototype.correctInvalidNumbers=function(t,e,n,o){e<0&&(t.cells[1]="0"),n<0&&(t.cells[3]="0"),o<0&&(t.cells[4]="0")},e.prototype.handleDoubleExport=function(t,e,n){var o=+e.export_amount_per_min,r=+e.export_amount_per_min2/o;if(t.doubleExport){var i=n*r,s=n*r-+t.extraCells[1];t.extraCells[0]=e.secondItemName,this.updateDoubleExport(t,n,t.extraCells[1],s),s<+t.extraCells[1]&&(t.extraCells[1]=i.toString())}else s=n*r,t.extraCells=[e.secondItemName,"0",s.toString()],t.doubleExport=!0},e.prototype.updateDoubleExport=function(t,e,n,o){this.checkIfNumbersAreValid(e,+n,o)?t.extraCells[2]=o.toString():(e<0&&(t.cells[1]="0"),+n<0&&(t.extraCells[1]="0"),o<0&&(t.extraCells[2]="0"))},e.prototype.checkIfNumbersAreValid=function(t,e,n){return!(t<0||e<0||n<0||t<e||e>t)},e}(r),m=function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{l(o.next(t))}catch(t){i(t)}}function a(t){try{l(o.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((o=o.apply(t,e||[])).next())}))},y=function(t,e){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},g=function(){function t(){}return t.importData=function(){return m(this,void 0,void 0,(function(){var t,e,n,o,r,i;return y(this,(function(s){return this.checkIfFileIsSelected()&&this.checkIfFileIsJson()?(t=new v("recipes",!0),e=new c("power",t,!0),n=new p("imports",t,!0),o=$("#importFile").prop("files")[0],r=new FileReader,i=this,r.readAsText(o),r.onload=function(){return m(this,void 0,void 0,(function(){var o,s,a;return y(this,(function(l){switch(l.label){case 0:return o=JSON.parse(r.result),Promise.all([t.importData(o.productionTable),e.importData(o.powerTable),n.importData(o.importTable)]).catch((function(t){console.error(t),i.showErrorMessage("An error occurred while importing the data. Please try again.")})),document.getElementById("importFile").value="",s=new URL(window.location.href),a=parseInt(s.searchParams.get("id")),[4,i.saveData(o,a)];case 1:return l.sent().success?(i.showSuccessMessage("Data successfully imported."),[2]):(i.showErrorMessage("An error occurred while importing the data. Please try again."),[2])}}))}))},[2]):[2]}))}))},t.exportData=function(){var t=new v("recipes",!0),e={productionTable:t,powerTable:new c("power",t,!0),importTable:new p("imports",t,!0)},n=(new TextEncoder).encode(JSON.stringify(e)),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download=this.generateFileName(),i.click(),URL.revokeObjectURL(r),this.showSuccessMessage("Data successfully exported.")},t.checkIfFileIsSelected=function(){var t,e=document.getElementById("importFile");if(!(null===(t=e.files)||void 0===t?void 0:t.length)){e.classList.add("is-invalid");var n=e.nextElementSibling;return n&&n.classList.add("d-block"),!1}e.classList.remove("is-invalid");var o=e.nextElementSibling;return o&&o.classList.remove("d-block"),!0},t.checkIfFileIsJson=function(){var t,e=document.getElementById("importFile"),n=null===(t=e.files)||void 0===t?void 0:t[0];if(n&&"application/json"!==n.type){e.classList.add("is-invalid");var o=e.nextElementSibling;return o&&(o.textContent="Please select a valid JSON file.",o.classList.add("d-block")),!1}return!0},t.showMessage=function(t,e){var n=document.getElementById(t);n&&(n.textContent=e,n.classList.add("d-none"),n.classList.remove("show"),n.offsetWidth,n.classList.remove("d-none"),n.classList.add("show"),setTimeout((function(){n.classList.remove("show"),setTimeout((function(){n.classList.add("d-none")}),150)}),5e3))},t.showSuccessMessage=function(t,e){void 0===e&&(e=1),1!==e?2!==e||this.showMessage("saveSuccessAlert",t):this.showMessage("successAlert",t)},t.showErrorMessage=function(t,e){void 0===e&&(e=1),1!==e?2!==e||this.showMessage("saveErrorAlert",t):this.showMessage("errorAlert",t)},t.generateFileName=function(){var t=Intl.DateTimeFormat().resolvedOptions().timeZone,e=(new Date).toLocaleString("en-GB",{timeZone:t}).replace(/[\/\s,:]/g,"_"),n=$("#productionLineName").text().replace(/\s/g,"_");return"".concat(n,"_data_").concat(e,".json")},t.saveData=function(t,e){return m(this,void 0,void 0,(function(){return y(this,(function(n){return[2,new Promise((function(n,o){$.ajax({type:"POST",url:"saveProductionLine",data:{data:JSON.stringify(t),id:e},success:function(t){n(JSON.parse(t))},error:function(t,e,n){o(n)}})}))]}))}))},t.saveProductionLine=function(){var t=this,e=new v("recipes",!0),n={productionTable:e,powerTable:new c("power",e,!0),importTable:new p("imports",e,!0)},o=new URL(window.location.href),r=parseInt(o.searchParams.get("id"));this.saveData(n,r).then((function(e){e.success?t.showSuccessMessage("Data successfully saved.",2):t.showErrorMessage("An error occurred while saving the data. Please try again.",2)})).catch((function(e){t.showErrorMessage("An error occurred while saving the data. Please try again.",2)}))},t}(),R=new v("recipes",!0);R.renderTable(),new c("power",R,!0).renderTable(),new p("imports",R,!0).renderTable(),document.addEventListener("DOMContentLoaded",(function(){var t=document.getElementById("importButton"),e=document.getElementById("exportButton");t&&t.addEventListener("click",(function(){return g.importData()})),e&&e.addEventListener("click",(function(){return g.exportData()})),document.getElementById("save_button").addEventListener("click",(function(t){t.shiftKey&&(t.preventDefault(),g.saveProductionLine())}))}))})();